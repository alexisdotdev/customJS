var Aseguradoras = [
  {
    "ID": 1,
    "Nombre": "Ana Seguros",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 2,
    "Nombre": "Atlas",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 3,
    "Nombre": "AXA",
    "Icon": "/Content/img/logo-axa-blanco.svg",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 5,
    "Nombre": "Bx+",
    "Icon": "/Content/img/logo-bx-blanco.svg",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 7,
    "Nombre": "GNP",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 10,
    "Nombre": "Mapfre",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 12,
    "Nombre": "Qualitas",
    "Icon": "/Content/img/logo-qualitas-blanco.svg",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": false
        }
      },
      "Multiplataforma": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": false
        }
      }
    }
  },
  {
    "ID": 14,
    "Nombre": "Zurich",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 15,
    "Nombre": "El Potosi",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": false
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": false
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": false,
          "Factura": false
        }
      }
    }
  },
  {
    "ID": 23,
    "Nombre": "Chubb de México",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  },
  {
    "ID": 43,
    "Nombre": "HDI",
    "Icon": "",
    "Configuracion": {
      "Particular": {
        "Activo": true,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Uber": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      },
      "Multiplataforma": {
        "Activo": false,
        "ValorIndemnizacion": {
          "Comercial": true,
          "Convenido": true,
          "Factura": true
        }
      }
    }
  }
]

var Modelos = [
  {
    "MarcaId": 1,
    "Marca": "Acura",
    "ModeloId": 3804,
    "Modelo": "ILX",
    "Anios": [
      2020,
      2019,
      2018,
      2017,
      2016,
      2015,
      2014,
      2013,
      2012
    ]
  },
  {
    "MarcaId": 29,
    "Marca": "Chevrolet",
    "ModeloId": 4128,
    "Modelo": "Tornado",
    "Anios": [
      2025,
      2024,
      2023,
      2022,
      2021,
      2020,
      2019,
      2018,
      2017,
      2016,
      2015,
      2014,
      2013,
      2012,
      2011,
      2010
    ]
  },
  {
    "MarcaId": 30,
    "Marca": "Chrysler",
    "ModeloId": 4132,
    "Modelo": "Town & Country",
    "Anios": [
      2017,
      2016,
      2015,
      2014,
      2013,
      2012,
      2011,
      2010
    ]
  },
  {
    "MarcaId": 42,
    "Marca": "Dodge",
    "ModeloId": 3633,
    "Modelo": "D-350",
    "Anios": [
      2011,
      2010
    ]
  },
  {
    "MarcaId": 42,
    "Marca": "Dodge",
    "ModeloId": 6068,
    "Modelo": "D-600",
    "Anios": [
      2012,
      2011,
      2010
    ]
  },
  {
    "MarcaId": 49,
    "Marca": "Ferrari",
    "ModeloId": 6314,
    "Modelo": "296",
    "Anios": [
      2024,
      2023,
      2022
    ]
  },
  {
    "MarcaId": 50,
    "Marca": "Fiat",
    "ModeloId": 5751,
    "Modelo": "Argo",
    "Anios": [
      2025,
      2024,
      2023,
      2022,
      2021,
      2020
    ]
  },
  {
    "MarcaId": 51,
    "Marca": "Ford",
    "ModeloId": 3657,
    "Modelo": "Econoline Van",
    "Anios": [
      2022,
      2021,
      2020,
      2019,
      2018,
      2017,
      2016,
      2015,
      2014,
      2013,
      2012,
      2011,
      2010
    ]
  },
]

let tagVehiculos = [];

let PerfilCotizacion = {
  marca: "",
  marcaId: 0,
  modelo: "",
  modeloId: 0,
  anio: 0,
  aseguradoras: [],
}

const configuracion = {
  layoutConfig: {
    inlineLayout: false,
    pillShape: true
  }
};

document.addEventListener("DOMContentLoaded", () => {
  const wrapper = document.querySelector(".divFormulario");
  const btnContainer = wrapper.querySelector(".btn-container");
  const row = wrapper.parentElement;

  fetchLayoutConfig()
    .then(({ layoutConfig: cfg }) => {
      const { inlineLayout, pillShape } = cfg;
      const btn = document.getElementById("btnCotizar");

      btn.classList.toggle("rounded-pill", pillShape);
      btn.classList.toggle("rounded", !pillShape);

      if (inlineLayout) {
        wrapper.classList.add("inline");
        wrapper.appendChild(btnContainer);
      } else {
        wrapper.classList.remove("inline");
        row.appendChild(btnContainer);
        btn.style.marginTop = "3.13rem";
      }

      document.querySelector('.inputAuto').classList.remove('inputAutoLoader');
      document.getElementById('txt_vehiculo').removeAttribute('disabled');

      Modelos.map((m, i) => {
        tagVehiculos.push({
          'label': m.Marca + ' ' + m.Modelo,
          'value': m.MarcaId + '-' + m.ModeloId
        });
      });

      $("#txt_vehiculo").autocomplete({
        source: tagVehiculos,
        minLength: 2,
        maxResults: 10,
        source: function (request, response) {
          let results = $.ui.autocomplete.filter(tagVehiculos, request.term);
          response(results.slice(0, this.options.maxResults));
        },
        //focus: function (event, ui) {
        //    $(this).val(ui.item.label);
        //    return false;
        //},
        select: function (event, ui) {
          $(this).val(ui.item.label);
          return false;
        }
      })
        .on('keypress', function (e) {
          AutoComplete();
        })
        .on('keydown', function (event) {
          AutoComplete();
        })
        .on('focusout', function (event) {
          AutoComplete();
        })
        .on('autocompleteselect', function (e, ui) {
          $('#txt_anioAuto').removeAttr('disabled', 'disabled');

          AutoCompleteAnios(ui.item.value);
        });

    })
    .catch(err => console.error("Error cargando layoutConfig:", err));

  $('#txt_anioAuto').click(function () {
    $('#error_perfilador').addClass('input_hidden');
    $('#containerKebab_anioAuto').show().addClass('activo');
  });

  $('#btnCotizar').click(function () {
    $('#error_perfilador').addClass('input_hidden');

    let valMarca = (PerfilCotizacion.marca != '') ? true : false;
    let valAnio = (PerfilCotizacion.anio != 0) ? true : false;

    if (valMarca && valAnio) {
      console.log('se manda datos para cotizar');
    }
    else {
      if (!valMarca)
        $('#error_perfilador').html('* Selecciona la marca de tu vehiculo');
      else if (!valAnio)
        $('#error_perfilador').html('* Selecciona el año de tu vehiculo');
      $('#error_perfilador').removeClass('input_hidden');
    }
  });

  window.addEventListener("click", (e) => {
    if ($('#containerKebab_anioAuto').hasClass('activo')) {
      if (!document.getElementById('containerAnioAuto').contains(e.target) && !d.getElementById('menuKebab_anioAuto').contains(e.target)) {
        $('#containerKebab_anioAuto').hide();
      }
    }
  });
});

function fetchLayoutConfig() {
  return new Promise(res => {
    setTimeout(() => res(configuracion), 300);
  });
}


function AutoCompleteAnios(valor_item) {
  $("#containerKebab_anioAuto .menuKebab").empty();

  let vehiculo = valor_item.split('-');

  let ListaAnios = Modelos.filter(m => m.MarcaId == vehiculo[0] && m.ModeloId == vehiculo[1]);

  if (ListaAnios[0] != undefined) {
    PerfilCotizacion.marca = ListaAnios[0].Marca;
    PerfilCotizacion.marcaId = parseInt(ListaAnios[0].MarcaId);
    PerfilCotizacion.modelo = ListaAnios[0].Modelo;
    PerfilCotizacion.modeloId = parseInt(ListaAnios[0].ModeloId);

    if (ListaAnios[0].Anios != undefined) {
      let encontreAnio = (ListaAnios[0].Anios.indexOf(PerfilCotizacion.anio) >= 0) ? true : false;
      if (encontreAnio) {
        $('#txt_anioAuto').html(`${PerfilCotizacion.anio} <span class="material-icons">keyboard_arrow_down</span>`);
      }
      else {
        $('#txt_anioAuto').html(`Año <span class="material-icons">keyboard_arrow_down</span>`);
        PerfilCotizacion.anio = 0;
      }

      $("#containerKebab_anioAuto .menuKebab").empty();
      let listaKebab = ``;
      ListaAnios[0].Anios
        .sort(function (a, b) { return b - a })
        .map((m, i) => {
          listaKebab += `
                          <div class="opcionKebab ${(encontreAnio && PerfilCotizacion.anio == m) ? `activo` : ``}" valor="${m}">
                              <span>${m}</span>
                          </div>
                      `;
        });
      $("#containerKebab_anioAuto .menuKebab").html(listaKebab);

      $('#containerKebab_anioAuto .opcionKebab').click(function () {
        $('#containerKebab_anioAuto').hide().removeClass('activo');
        $('#containerKebab_anioAuto .opcionKebab').removeClass('activo');
        $(this).addClass('activo');

        PerfilCotizacion.anio = parseInt($(this).attr('valor'));
        $('#txt_anioAuto').html(`${PerfilCotizacion.anio} <span class="material-icons">keyboard_arrow_down</span>`);
      });
    }
  }
  else {
    PerfilCotizacion.marca = '';
    PerfilCotizacion.marcaId = 0;
    PerfilCotizacion.modelo = '';
    PerfilCotizacion.modeloId = 0;

    $('#txt_anioAuto').attr('disabled', 'disabled');
  }
}

function AutoComplete() {
  $('#error_perfilador').addClass('input_hidden');

  if ($("#txt_vehiculo").val() == '') {
    PerfilCotizacion.marca = '';
    PerfilCotizacion.marcaId = 0;
    PerfilCotizacion.modelo = '';
    PerfilCotizacion.modeloId = 0;

    $('#txt_anioAuto').attr('disabled', 'disabled');
  }
}
